---
title: "Case Study: Ankylosing Spondylities"
author: 'Author Name'
date: 'October 8, 2020'
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r Front Matter, include=FALSE}

# clean up & set default chunk options
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning = FALSE,fig.width=6, fig.height=4)

# packages
library(tidyverse) 
library(mosaic)
library(summarytools)
library(kableExtra)
library(magrittr)
library(lme4)
library(lmerTest)

# Data

data <- read.csv("Ankylosing_Spondilitus_data_clean.csv")
colnames(data)[1] <- "patientNo"
```


\newpage


# Project Description

Ankylosing spondylitis (AS) is an inflammatory disease which limits the motion of the spine and muscles. The disease affects the joints of the spinal and peripheral joints such as the shoulder, hip, knee, and ankle. If ribs are affected, it can be difficult to breathe deeply. As a result, people with AS demonstrate inspiratory muscle fatigue during exercise and limited capacity of maximal oxygen. These restrictions lead to decreased daily activity and to decreased quality of life in people with AS.

Some research reveals that exercise is as crucial as drug treatment in the management of AS. To further confirm this hypothesis, a study was carried out at the Royal National Hospital to examine the effects of daily stretching of tissues around the hip on the joints flexibility of AS patients.

In this study, out of 39 patients with AS, 12 were randomly chosen to a control group receving the standard treatment. The other 27 patients received additional stretching excersices. Several measurements were made on each hip when the patients were admitted and three weeks after the treatment. This report will focus on two important measure, flexion and lateral rotation.


## Research Questions


**Question:**  Whether the stretching excercise can help AS patients get more movement in their hip joints


## Statistical Questions

**Question:** Are the measurement of stretched group significantly better compared to control group?


## Variables

After data cleaning, there are 7 variables in the dataset.

- `flexionBefore`: hip joints flexion before treatment (in degrees, an increase represents an improvement)
- `flexionAfter`: hip joints flexion after treatment (in degrees, an increase represents an improvement)
- `rotationBefore`: hip joints rotation before treatment (in degrees, an increase represents an improvement)
- `rotationAfter`: hip joints rotation after treatment (in degrees, an increase represents an improvement)
- `hip`: Right or Left
- `treatment`: Control or Stretch
- `patient`: unique patient identification number, 1 to 39


# Exploratory Data Analysis (EDA)

```{r Data Cleaning}
# Data Cleaning
control_group <- read.table("Ankylosing_Spondilitus_data.txt", 
                            skip = 4, 
                            na.strings = '*',
                            colClasses = c(rep("double", 4), rep("NULL", 4)))

control_group <- control_group %>%
  na.omit() %>%
  setNames(., c("flexionBefore","flexionAfter","rotationBefore","rotationAfter")) %>%
  mutate(hip = rep(c('Right','Left'),12),
         treatment = 'Control',
         patientNo = rep(1:12,each=2))

stretched_group <- read.table("Ankylosing_Spondilitus_data.txt", 
                               skip = 4, 
                               na.strings = '*',
                               colClasses = c(rep("NULL", 4), rep("double", 4)))

stretched_group <- stretched_group %>%
  na.omit() %>%
  setNames(., c("flexionBefore","flexionAfter","rotationBefore","rotationAfter")) %>%
  mutate(hip = rep(c('Right','Left'),27),
         treatment = 'Stretch',
         patientNo = rep(13:39,each=2))

clean_data <- rbind(control_group, stretched_group)
clean_data$patientNo <- as.factor(clean_data$patientNo)
```
 
From the Table 1 of summary statistics, we can find that the overall condition of the hip joints of AS patients has improved. Table 2 compares the measurement between the two different treatment group.

```{r summary-statistics}
# measurements summary statistics 
descr(clean_data, style = 'rmarkdown') %>% 
  knitr::kable(digits = 3,
               caption = "Summary Statistics for measurements")

stby(clean_data, clean_data$treatment, descr, stats = "fivenum") %>%
  tb(order = 1) %>%
  knitr::kable(caption = "Summary Statistics for measurements 
               in different treatment group") %>%
  collapse_rows(columns = 1, valign = "top")
```


```{r EDA-histogram1, fig.cap="Histogram of flexion in different groups"}
# Figure 1
clean_data %>%
  gather("key","value",1:4) %>%
  filter(key %in% c("flexionAfter", "flexionBefore")) %>%
  ggplot(aes(x=value,fill=key)) + 
  geom_histogram(aes(y = ..density..),alpha=0.3,colour="grey40",bins=20) +
  geom_density(colour="grey40",alpha=0.1) +
  facet_grid(.~treatment) + 
  xlab("flexion")

```

```{r EDA-histogram2, fig.cap="Histogram of rotation in different groups"}
# Figure 2
clean_data %>%
  gather("key","value",1:4) %>%
  filter(key %in% c("rotationAfter", "rotationBefore")) %>%
  ggplot(aes(x=value,fill=key)) + 
  geom_histogram(aes(y = ..density..),alpha=0.3,colour="grey40",bins=20) +
  geom_density(colour="grey40",alpha=0.1) +
  facet_grid(.~treatment) + 
  xlab("rotation")

```


Figure 1 and Figure 2 show that the patients in both the control and stretch groups have some imporvement. But it is difficult to tell whether the improvement in stretch is more than the control group. 

Next, we will look into more details about the increase of those measurements. Figure 3 and Figure 4 show the relationship of the the measurement before and after the treatment. 

```{r EDA-scatterplot1, fig.cap="Scatter plot of flexion before and after treatment"}
# Figure 3
clean_data %>%
  ggplot(aes(x = flexionBefore, y = flexionAfter)) + 
  geom_point(aes(color = treatment)) + 
  geom_smooth(aes(color = treatment),method = "loess", se = 0) + 
  geom_abline(slope = 1)
```

```{r EDA-scatterplot2, fig.cap="Scatter plot of rotation before and after treatment"}
# Figure 4
clean_data %>%
  ggplot(aes(x = rotationBefore, y = rotationAfter)) + 
  geom_point(aes(color = treatment)) + 
  geom_smooth(aes(color = treatment),method = "loess", se = 0) + 
  geom_abline(slope = 1)
```


These two graphs exihibit some interesting results. First of all, the vertical distance from each point to the diagonal line `y = x` represents the change of measurements after treatment. Above the line means an inprovement whereas below the line means a worse condition. From the the two figures, the improvement seems to has an negative correlation with the patients' base condition. If the patients are in relatively serious condition, the treatment will have a larger impact on them. Secondly, these two figures also show that the stretch group has better improvement than the control group since the fitted curve for the stretch group is above the curve for the control group. Third, it is notable that there are three outliers in the flexition figure that we need to handle more carefully. Those records have very low flextion before the treatment but have very significant improvement afterwards. It may due to the individual randomness but it is also likely that the flextion measurement before treatment is inaccurate.
The next Figure investigates the boxplot of the flextion. From the plot, we can see that those three points are far from the normal range of the flextion, which confirms our concerns.

```{r EDA-boxplot1, fig.cap="boxplot of flextion before and after treatment"}
# Figure 5
clean_data %>%
  gather("key","value",1:4) %>%
  filter(key %in% c("flexionAfter", "flexionBefore")) %>%
  ggplot(aes(y=value,x=reorder(key,value), fill=reorder(key,value))) + 
  geom_boxplot()+
  labs(y='flexion', x='time', fill='time')
```


After examing the distribution of measurement, it seems approporiate to use the difference of measurement after and before the treatment as an indicator of the improvement of the patients. We will use two variables `flexionIncrease` and `rotationIncrease` to denote the increase for the two measurements.
Figure 6 and 7 shows the comparasion of the increase on left and right hips and on control and stretch groups.

```{r EDA-boxplot2, fig.cap="boxplot of flextion increase"}
# Figure 6
clean_data %>%
  mutate(flexionIncrease = flexionAfter-flexionBefore, 
         rotationIncrease = rotationAfter-rotationBefore) %>%
  ggplot(aes(y=flexionIncrease, x=hip, fill=treatment)) +
  geom_boxplot()
```

```{r EDA-boxplot3, fig.cap="boxplot of rotation increase"}
# Figure 7
clean_data %>%
  mutate(flexionIncrease = flexionAfter-flexionBefore, 
         rotationIncrease = rotationAfter-rotationBefore) %>%
  ggplot(aes(y=rotationIncrease, x=hip, fill=treatment)) +
  geom_boxplot()
```


From the two boxplots, we can find two important insights. Firstly, the improvement in difference treatment groups show that the improvement in rotation is more significant than the improvement in flexion. Secondly, the increase of measurments exhibits similar patterns in both left and right hips.

Next, we will look at the correlations among patients' left and right hips. It is natural to think that the improvement on the same patients should be positively correlated. The following figure further confirms this relationship. This finding means that we cannot treat all the records as independent samples. We will further explained it in the modeling part. 

```{r EDA-corrplot, fig.cap="scatterplot of increase in left and right hips"}
# Figure 8
clean_data <- clean_data %>%
  mutate(flexionIncrease = flexionAfter-flexionBefore, 
         rotationIncrease = rotationAfter-rotationBefore)

gridExtra::grid.arrange(
clean_data %>%
  select(treatment, patientNo, flexionIncrease, hip) %>%
  group_by(patientNo) %>%
  spread(hip, flexionIncrease) %>%
  ggplot(aes(x=Left, y=Right)) +
  geom_smooth(alpha=0.1, span=1, linetype = "dashed")+
  geom_point(aes(color=treatment)) +
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) +
  ggtitle("flexion Increase")
,
clean_data %>%
  select(treatment, patientNo, rotationIncrease, hip) %>%
  group_by(patientNo) %>%
  spread(hip, rotationIncrease) %>%
  ggplot(aes(x=Left, y=Right)) +
  geom_smooth(alpha=0.1, span=1, linetype = "dashed")+
  geom_point(aes(color=treatment)) +
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) +
  ggtitle("ratation Increase")
,nrow = 1)
```


# Statistical Analysis 

As described in previous sections, this dataset actually contains three different levels of observations. Level 1 is the record of each hip. Level 2 consists of different patients, and level 3 contains our two treatment groups. In order to take into consideration the variation among patients and treatment groups, we will use a three-level model to represent our problem.

Then we also need to choose which effects we should include in our model for different sources of variability. Since the treatment group is our research goal, we will associate fixed effects to the treatment. And because our patients are randomly chosen, we assume the patients are from certain probability distribution and associate random effects with them.


## Model Structure

We use a three-level model. The model can be expressed as

- Level One (hip records for each patient):
$$
Y_{ijk} = a_{ij}+\epsilon_{ijk}, \ \textrm{ where } \epsilon_{ijk}\sim N(0,\sigma^2)
$$
- Level Two (patients within each treatment group):
$$
a_{ij} = a_{i}+u_{ij},\ \textrm{ where } u_{ij}\sim N(0,\sigma_{u}^{2})
$$

- Level Three (treatment):
$$
a_{i} = \alpha_{0} + \alpha_1 \text{Stretch}_i
$$

- $Y_{ijk}$ is the increase of flexion (or rotation) of hip $k$ (Left or Right) of patient $j$ from group $i$(Control or Stretch). 
- $a_{ij}$ is the true mean increase for patient $j$ from group $i$.
- $a_i$ is the true mean increase for group $i$.
- $\alpha_0$ is the mean increase for control group and $\alpha_1$ is the mean increase for stretch group relative to the control group.

We can also express it as a composite model:
$$
Y_{ijk}=\alpha_{0}+\alpha_1 \text{Stretch}_i+u_{ij}+\epsilon_{ijk}
$$

## Model results

In order to model the effects of stretching on the flexion and rotation scores, we fit a linear mixed effects model, meaning a model that considers variables that are both fixed effects, which are effects for which we only care about the levels included in the model, and random effects, which are effects for which the levels shown in the data are not the only levels that we consider. We will use the score at the end of the period as our response variable.

The treatment, i.e. stretch or no stretch, clearly will function as a fixed effect with the control group as the baseline, meaning that our resulting coefficients will consider the treatment group relative to the control group. We saw in our exploratory data analysis that there does appear to be some difference between the effects on the right or left hip, so we will also include the hip as a fixed effect, which will consider the left hip as a baseline. 

For our random effects, we will want to consider the variation between patients, since the scores of the right and left hip for a particular patient are likely to be related to one another, which is supported by the exploratory plots. We will also want to include the starting level of flexion or rotation for each model as a random effect as it is reasonable that the starting score would have an impact on the ending score. We also suspect that the starting score could impact how much improvement a person could reasonably expect to see, which is our primary reason to consider a model including both the before and after scores as opposed to predicting the change between the two.

While we did consider interaction terms between these effects, we determined these interaction terms to be insignificant and therefore excluded them from the models. The results of these models are shown in Tables 3-6. 


```{r Model1-flexion} 
model1Flexion <- lmer(flexionAfter ~ (1 | flexionBefore) + treatment + 
                        hip + (1 | patientNo), data = clean_data)
mod <- summary(model1Flexion)$coefficients

rownames(mod) <- c("(Intercept)", "Treatment", "Right Hip")
knitr::kable(mod, escape=F,
             align = c('c', rep('r', 9)),
             caption = "Effects on Flexion Improvement") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position") 

m <- summary(model1Flexion)
n <- m$varcor

df <- data.frame(Group = c("Patient", "Flexion Before", "Residual"), 
                 Variance = c(25.999, 63.097, 8.875))
#n$Std.Dev. <- as.numeric(n$Std.Dev.)^2
knitr::kable(df, escape=F,
             align = c('c', rep('r', 9)), caption = "Variance for Random Effects of Flexion") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position") 
```
 
 Considering the model for flexion, the results of which are shown in Tables 3 and 4, we see that after controlling for the variance between patients, the prior flexion score, and any differences between the left and right hip, there is a significant, defined as having a p-value of less than .05, which means that there is less than a .05 chance that results at least as extreme as were seen would occur if the variable was not significant, improvement from stretching, with the expected improvement, all other things constant, being about 7.8.
 
 
```{r Model1-rotation} 
model1Rotation <- lmer(rotationAfter ~ (1 | rotationBefore) + hip + 
                         treatment + (1 | patientNo), data = clean_data)
mod <- summary(model1Rotation)$coefficients

rownames(mod) <- c("(Intercept)", "Treatment", "Right Hip")
# knitr::kable(mod, escape=F,
#              align = c('c', rep('r', 9)),
#              caption = "Effects on Rotation Improvement") %>%
#   kableExtra::kable_styling(position ="float_left", full_width = F) 
m <- summary(model1Flexion)
n <- m$varcor

df <- data.frame(Group = c("Patient", "Rotation Before", "Residual"), Variance = c(23.218, 65.006, 7.807))
#n$Std.Dev. <- as.numeric(n$Std.Dev.)^2
#gridExtra::grid.arrange(
knitr::kable(mod, escape=F,
             align = c('c', rep('r', 9)),
             caption = "Effects on Rotation Improvement") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")

knitr::kable(df, escape=F,
             align = c('c', rep('r', 9)), , caption = "Variance for Random Effects of Rotation") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position") 
#nrow = 1
#)
```

```{r}
# intervals <-confint(model1Flexion, level = 0.95, oldNames = FALSE)
# row.names(intervals)[c(4,1,2)] <- c("Intercept", "Patient Number", "Rotation Before")
# knitr::kable(
#   intervals[c(4,1,2),],
#   digits = 3,
#   caption = "Upper and Lower Confidence Bounds-90% SCI, Bonferroni Adj. DO WE WANT SOMETHING LIKE THIS??",
#   align = c('l',rep('c',2))
# ) %>%
#   kableExtra::kable_styling(
#     bootstrap_options = c("striped", "condensed"),
#     font_size = 12, latex_options = "HOLD_position")
# 
# intervals <-confint(model1Rotation, level = 0.95, oldNames = FALSE)
# row.names(intervals)[c(4,1,2)] <- c("Intercept", "Patient Number", "Rotation Before")
# knitr::kable(
#   intervals[c(4,1,2),],
#   digits = 3,
#   caption = "Upper and Lower Confidence Bounds-90% SCI, Bonferroni Adj. DO WE WANT SOMETHING LIKE THIS??",
#   align = c('l',rep('c',2))
# ) %>%
#   kableExtra::kable_styling(
#     bootstrap_options = c("striped", "condensed"),
#     font_size = 12, latex_options = "HOLD_position")
```
 
 Considering the model for rotation, we see that after controlling for the variance between patients, the prior rotation score, and any differences between the left and right hip, there is a significant, using the same metric as flexion with a p-value <.05, improvement from stretching, with the expected improvement, all other things constant, being about 2.9.
 
Beyond noticing that stretching does appear to lead to a significant increase in both flexion and rotation, there are several other notable components of these results. It is unsurprising to see that both the variance between patients and the variance based on the starting score account for a fair amount of variation, which are significant at the .05 level using a Bonferroni adjustment (not shown in the tables). The effect of the hip, right or left, is interesting in that it only has a significant effect for the rotation score. In fact, the right hip is expected to have an ending rotation score 5.8 better than the left, all other things equal. A possible reason for this result could be that the more people tend to be right leg dominant, so the daily actions of the right hip may have differences that impact the rotation score. Of course, this is purely a guess as to a possible cause that would require further analysis to prove or disprove.


### Model Diagnostics

We performed some model diagnostics and tested the assumptions of our multilevel model.

#### Linearity and Homogeneity of Variance

Generally, multilevel models response is assumed to be linear with respect to the predicted value with constant variance. Residual plots are a useful tool to examine these assumptions. Figure 9 shows the residual with respect to the fitted value.

```{r model-test-resid, fig.cap="Residuals plot for models"}
# Figure 10
gridExtra::grid.arrange(
ggplot(fortify.merMod(model1Flexion), aes(x = .fitted, y = .resid)) + 
  geom_point() +
  geom_hline(yintercept = 0) +
  ylim(-11,17) +
  ggtitle("residuals of flexion model")
,
ggplot(fortify.merMod(model1Rotation), aes(x = .fitted, y = .resid)) + 
  geom_point() +
  geom_hline(yintercept = 0) +
  ylim(-11,17) +
  ggtitle("residuals of rotation model")
,
nrow = 1)
```

The residual plots do not indicate any deviations from a linear form. There are some outliers in the plot of flexion model. But the plot for rotation model also shows relatively constant variance across the fitted range.


#### Normality of residuals

Our model also assumes that the residuals follow the Normal distribution. We can use Q-Q plot to test the normality of model residuals. Figure 10 displays the Q-Q plots for both models.

```{r model-test-qq, fig.cap="Q-Q plot for models"}
# Figure 11
gridExtra::grid.arrange(
ggplot(fortify.merMod(model1Flexion), aes(sample = .resid)) + 
  stat_qq() + 
  stat_qq_line() +
  ylim(-10,10) +
  ggtitle("Q-Q plot of flexion model")
,
ggplot(fortify.merMod(model1Rotation), aes(sample = .resid)) + 
  stat_qq() + 
  stat_qq_line()+
  ylim(-10,10) +
  ggtitle("Q-Q plot of rotation model")
,
nrow = 1)
```


From QQ plots, the residuals of the two models are close to normal distributions.

Overall, the results indicate that our model meets the basic assumptions.

# Recommendations 

**Research Question:**  The stretch excercise can help AS patients improve their hip joints condition, especially for lateral rotation.

**Statistical Question:** The improvement for rotation is significant in stretched group compared to control group. But the imporvement for flexion is not significant.


# Additional Considerations

- Some other factors that may also affect the improvement like patients age, years of getting AS, health condition etc. are not included in the dataset. Those information will be helpful to further distinguish the reason of improvement.
- There are three outliers in the flexion data, which may be caused by measurment errors. The study may need to be more careful about data collection.


# Technical Appendix

### R Script
```{r ref.label=c('Front Matter', 'Data Cleaning', 'summary-statistics', 'EDA-histogram1','EDA-histogram2', 'EDA-scatterplot1','EDA-scatterplot2', 'EDA-boxplot1','EDA-boxplot2','EDA-boxplot3', 'EDA-corrplot', 'Model1-flexion', 'Model1-rotation','model-test-resid','model-test-qq'), echo=TRUE, eval=FALSE}
# Reprinted code chunks used previously for analysis
```



